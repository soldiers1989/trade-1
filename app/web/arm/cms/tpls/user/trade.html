
<div class="easyui-layout" data-options="fit:true, split:true, border: true">
    <div data-options="region:'west', split:true" style="width: 72%">
        <table id="datagrid_trade" style="height: 100%;"></table>
    </div>
    <div data-options="region:'center', split:true" style="width: 28%; height: 100%">
        <div class="easyui-tabs" id="tabs_trade_detail" fit="true" border="true" plain="true" style="height: 100%;width: 100%">
            <div title="操作">
                <div class="easyui-panel" style="height:100%;width:100%">
                    <div style="margin: 6px; height: 5%; width: 100%">
                        <a href="#" id="btn_trade_buy" class="easyui-linkbutton" data-options="width:'60px'" onclick="usertrade.detail.operation.do('buy')">买入</a>
                        <a href="#" id="btn_trade_sell" class="easyui-linkbutton" data-options="width:'60px'" onclick="usertrade.detail.operation.do('sell')">卖出</a>
                        <a href="#" id="btn_trade_close" class="easyui-linkbutton" data-options="width:'60px'" onclick="usertrade.detail.operation.do('close')">平仓</a>
                        <a href="#" id="btn_trade_cancel" class="easyui-linkbutton" data-options="width:'60px'" onclick="usertrade.detail.operation.do('cancel')">撤单</a>
                        <a href="#" id="btn_trade_drop" class="easyui-linkbutton" data-options="width:'60px'" onclick="usertrade.detail.operation.do('drop')">弃单</a>
                    </div>
                    <div style="height:95%; width: 100%">
                        <iframe id="iframe_trade_quote" src="" style="height: 100%;width: 100%"></iframe>
                    </div>
                </div>
            </div>
            <div title="详情">
                <div class="easyui-panel" style="height:100%;width: 100%">
                    <table id="propertygrid_trade_detail"></table>
                </div>
            </div>
            <div title="费用">
                <div class="easyui-panel" style="height:100%;width: 100%">
                    <table id="datagrid_trade_fees"></table>
                </div>
            </div>
            <div title="保证金">
                <div class="easyui-panel" style="height:100%;width: 100%">
                    <table id="datagrid_trade_margins"></table>
                </div>
            </div>
            <div title="委托">
                <div class="easyui-panel" style="height:100%;width: 100%">
                    <table id="propertygrid_trade_orders"></table>
                </div>
            </div>
            <div title="状态">
                <div class="easyui-panel" style="height:100%;width: 100%">
                    <table id="propertygrid_trade_status"></table>
                </div>
            </div>
        </div>
        <div id="empty_trade_detail"><p style="text-align: center;">没有选择交易记录!</p></div>
    </div>
</div>

<div id="trade_toolbar">
    <span>
        <a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="usertrade.add.open()">新建</a>
    </span>
    <span>
        <a href="javascript:void(0)" id="trade_edit_menubutton" class="easyui-menubutton" data-options="menu:'#trade_edit_menu', disabled:true,iconCls:'icon-edit'">编辑</a>
        <div id="trade_edit_menu" style="width:150px;">
            <div iconCls="icon-edit" onclick="usertrade.edit.modify.open()">修改</div>
            <div iconCls="icon-remove" onclick="usertrade.edit.delete.do()">删除</div>
        </div>
    </span>
    <span style="float: right; margin-right: 18px;">
        <form class="easyui-form" id="trade_search_form">
            <input name="status" data-options="prompt:'交易状态', editable:false, required:false" style="width: 16%">
            <span>日期</span>
            <input name="sdate" class="easyui-datebox" validType="date" style="width: 18%">
            <span>-</span>
            <input name="edate" class="easyui-datebox" validType="date" style="width: 18%">

            <input name="words" class="easyui-textbox" style="width: 20%">

            <a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick="usertrade.search.go()">查询</a>
            <a href="#" class="easyui-linkbutton" iconCls="icon-reload" onclick="usertrade.search.reset()">重置</a>
        </form>
    </span>
</div>

<div class="easyui-dialog" id="trade_add_dialog" style="width:400px" data-options="closed:true,modal:true,border:'thin',buttons:'#trade_add_dialog_buttons'">
    <form class="easyui-form" id="trade_add_form" method="post" style="margin:0;padding:10px 20px">
        <div style="margin-bottom:10px">
            <input id="trade_add_user" name="user" label="用户" prompt="输入用户" style="width:100%" required>
        </div>
        <div style="margin-bottom:10px">
           	<input id="trade_add_stock" name="stock" label="股票" prompt="股票代码" style="width:100%" required>
        </div>
        <div style="margin-bottom:10px">
           	<input id="trade_add_lever" name="lever" label="杠杆" prompt="选择杠杆" style="width:100%" required>
        </div>
        <div style="margin-bottom:10px">
            <input id="trade_add_coupon" name="coupon" label="优惠券" prompt="选择优惠券" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input id="trade_add_ptype" name="optype" label="报价方式" prompt="选择报价方式" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="ocount" data-options="label:'委托数量', prompt:'100的整数倍', required:true, validType:['stock', 'min[100]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" id="trade_add_oprice" name="oprice" data-options="label:'委托价格', prompt:'>0.0', required:true, validType:['number', 'min[0]']" style="width:100%">
        </div>
    </form>
</div>

<div id="trade_add_dialog_buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" onclick="usertrade.add.save()" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="usertrade.add.close()" style="width:90px">取消</a>
</div>


<div class="easyui-dialog" id="user_trade_update_dialog" style="width:650px;height: 500px;" data-options="closed:true,modal:true,border:'thin',buttons:'#trade_update_dialog_buttons'">
    <form class="easyui-form" id="user_trade_update_form" method="post">
        <div class="easyui-layout" style="width: 620px;height: 480px;">
            <div region="west" style="width: 300px;padding: 10px;">
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox"  name="id" type="text" label="ID" style="width:100%" readonly>
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-combobox" name="account" data-options="label:'交易账户', prompt:'选择交易账户',
                                                                               method: 'get', url: '/api/trade/account/list?disable=false',
                                                                               valueField:'id',textField:'text',limitToList: true,
                                                                               loadFilter: function(resp) {
                                                                                    data = [];
                                                                                    for (i=0; i<resp.data.rows.length; i++){
                                                                                        data.push({id:resp.data.rows[i].account, text:resp.data.rows[i].name+'('+resp.data.rows[i].money+')'});
                                                                                    }
                                                                                    return data;
                                                                               }" style="width: 100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-combobox" name="status" data-options="label:'订单状态', prompt:'选择订单状态',
                                                                               method: 'get', url: '/api/enum?c=trade&i=status',
                                                                               valueField:'id',textField:'text',limitToList: true,
                                                                               loadFilter: function(resp) {
                                                                                    return resp.data;
                                                                               }" style="width: 100%" required>
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-combobox" name="optype" data-options="label:'报价方式', prompt:'选择报价方式',
                                                                               method: 'get', url: '/api/enum?c=order&i=price',
                                                                               valueField:'id',textField:'text',limitToList: true,
                                                                               onChange: function(nval, oval) {
                                                                                    tb = $('#tb_trade_update_oprice');
                                                                                    if (nval==='sj') {
                                                                                        tb.textbox('disable');
                                                                                    } else {
                                                                                        tb.textbox('enable');
                                                                                    }
                                                                               },
                                                                               loadFilter: function(resp) {
                                                                                    return resp.data;
                                                                               }" style="width: 100%" required>
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="ocount" data-options="label:'委托数量', prompt:'输入委托数量（股）', required:false, validType:['digits', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" id="tb_trade_update_oprice" name="oprice" data-options="label:'委托价格', prompt:'输入委托价格（元）', required:false, validType:['number', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="hcount" data-options="label:'持仓数量', prompt:'输入持仓数量（股）', required:false, validType:['digits', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="hprice" data-options="label:'持仓价格', prompt:'输入持仓价格（元）', required:false, validType:['number', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="fcount" data-options="label:'可用数量', prompt:'输入可用数量（股）', required:false, validType:['digits', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="bcount" data-options="label:'买入数量', prompt:'输入买入数量（股）', required:false, validType:['digits', 'min[0]']" style="width:100%">
                </div>
            </div>
            <div region="center" style="width:300px;padding: 10px;">
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="bprice" data-options="label:'买入价格', prompt:'输入买入价格（元）', required:false, validType:['number', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="scount" data-options="label:'卖出数量', prompt:'输入卖出数量（股）', required:false, validType:['digits', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="sprice" data-options="label:'卖出价格', prompt:'输入卖出价格（元）', required:false, validType:['number', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="margin" data-options="label:'初始保证金', prompt:'输入初始保证金（元）', required:false, validType:['number', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="amargin" data-options="label:'补充保证金', prompt:'输入补充保证金（元）', required:false, validType:['number', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="ofee" data-options="label:'建仓费', prompt:'输入建仓费（元）', required:false, validType:['number', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="dday" data-options="label:'延期天数', prompt:'输入延期天数(天)', required:false, validType:['digits', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="dfee" data-options="label:'延期费', prompt:'输入延期费（元）', required:false, validType:['number', 'min[0]']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="tprofit" data-options="label:'盈利总额', prompt:'输入盈利总额（元）', required:false, validType:['number']" style="width:100%">
                </div>
                <div style="margin-bottom:10px">
                    <input class="easyui-textbox" name="sprofit" data-options="label:'盈利分成', prompt:'输入盈利分成（元）', required:false, validType:['number', 'min[0]']" style="width:100%">
                </div>
            </div>
        </div>
    </form>
</div>

<div id="trade_update_dialog_buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" onclick="usertrade.edit.modify.save()" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="usertrade.edit.modify.cancel()" style="width:90px">取消</a>
</div>

<script type="text/javascript">
    // user trade list/add/update/delete
    var usertrade = {
        // trade add
        add: {
            url: '/api/user/trade/add',

            form: $('#trade_add_form'),
            dialog: $('#trade_add_dialog'),

            inited: false,

            init: function() {
                //init user textbox
                $('#trade_add_user').combobox({
                    url:'/api/user/user/query', 
                    mode: 'remote',

                    valueField:'id',
                    textField:'user',
                    
                    limitToList: true,
                    
                    loadFilter: function(resp) {
                        return resp.data;
                    },
                    
                    onChange: function(newv, oldv) {
                        if($(this).textbox('isValid')){
                            $('#trade_add_coupon').combobox({queryParams: {id:$(this).val(), _t:'usable'}}).combobox('reload', '/api/user/user/coupons');
                        }
                    }
                });

                //init stock combobox
                $('#trade_add_stock').combobox({
                    url:'/api/stock/stock/query',
                    mode: 'remote',

                    valueField:'id',
                    textField:'name',

                    limitToList: true,

                    loadFilter: function(resp) {
                        return resp.data;
                    }
                });

                //init lever combobox
                $('#trade_add_lever').combobox({
                    url:'/api/trade/lever/list',
                    queryParams: {
                        disable: 'false'
                    },

                    valueField:'id',
                    textField:'lever',

                    limitToList: true,

                    loadFilter: function(resp) {
                        return resp.data.rows;
                    }
                });

                //init coupon combobox
                $('#trade_add_coupon').combobox({
                    valueField: 'id',
                    textField: 'money',

                    limitToList: true,

                    loadFilter: function(resp) {
                        rows = [];
                        for(i=0; i<resp.data.rows.length; i++){
                            rows.push({id: resp.data.rows[i].id, money:resp.data.rows[i]._type+": "+resp.data.rows[i].value})
                        }
                        return rows;
                    }
                });

                //init ptype combobox
                $('#trade_add_ptype').combobox({
                    editable:false,
                    valueField: 'id',
                    textField: 'text',
                    data: [{id:'sj', text:'市价'},{id:'xj', text:'限价'}],
                    onChange: function(newv, oldv){
                        tb = $('#trade_add_oprice');
                        if (newv === 'sj'){
                            tb.textbox('clear');
                            tb.textbox('disable');
                        } else {
                            tb.textbox('clear');
                            tb.textbox('enable');
                        }
                    }
                });

                //set inited flag
                this.inited = true;
            },

            open: function() { //open dialog
                //reset form
                this.form.form('clear');

                //init add
                if (!this.inited)
                    this.init();

                //open dialog
                this.dialog.dialog('open').dialog('center').dialog('setTitle','添加订单');
            },

            close: function() { //close dialog
                //close dialog
                this.dialog.dialog('close');
            },

            save: function() { // save add record
                 //submit form
                this.form.form('submit',{
                    url: this.url,
   
                    onSubmit: function(){
                        return usertrade.add.form.form('validate');
                    },
                    success: function(data){
                        var resp = eval('('+data+')');
                        if (resp.status){
                            usertrade.add.close();
                            usertrade.list.insertRow(resp.data);
                        } else {
                            $.messager.show({ title: '错误',  msg: resp.msg });
                        }
                    }
                });
            }
        },

        // user trade edit
        edit: {
            menubutton: $('#trade_edit_menubutton'),

            // init edit
            init: function() {
                //init edit
            },

            // enable edit
            enable: function() {
                this.menubutton.menubutton('enable');
            },

            // disable edit
            disable: function() {
                this.menubutton.menubutton('disable');
            },

            //modify action
            modify: {
                url: '/api/user/trade/update',
                dialog: $('#user_trade_update_dialog'),
                form: $('#user_trade_update_form'),

                // open update dialog
                open: function() {
                    //get selected row data
                    row = usertrade.list.getSelected();
                    if (row){
                        // clear form
                        this.form.form('clear');

                        //load form data
                        this.form.form('load', row);

                        //open dialog
                        this.dialog.dialog('open').dialog('center').dialog('setTitle','修改交易订单');
                    }
                },

                // save update results
                save: function() {
                    //submit form
                    this.form.form('submit',{
                        url: this.url,
                        onSubmit: function(){
                            return usertrade.edit.modify.form.form('validate');
                        },
                        success: function(data){
                            var resp = eval('('+data+')');
                            if (resp.status){
                                usertrade.edit.modify.dialog.dialog('close');

                                //update selected row data
                                usertrade.list.updateSelected(resp.data);
                            } else {
                                $.messager.show({ title: '错误',  msg: resp.msg });
                            }
                        }
                    });
                },

                // cancel update operation
                cancel: function() {
                    //close dialog
                    this.dialog.dialog('close');
                }
            },

            // delete row
            delete: {
                do: function() { // delete
                    //get selected row data
                    var row = usertrade.list.getSelected();
                    if (!row)
                        return;

                    $.messager.confirm({
                        title: '确认',
                        msg: '确认删除交易订单 '+row.stock+'('+row.ocount+'股)'+'?',
                        url: '/api/user/trade/delete',
                        fn: function(r){
                            if (r){
                                $.post(this.url, {id: row.id}, function(resp, status){
                                    console.log(resp);
                                    console.log(status);
                                    if(status === 'success'){
                                        if (resp.status){
                                            usertrade.list.deleteSelected();
                                            usertrade.detail.clear();
                                        } else {
                                            $.messager.show({title: '错误', msg: resp.msg});
                                        }
                                    } else {
                                        $.messager.show({title: '错误', msg: '请求服务器错误'});
                                    }
                                },'json');
                            }
                        }
                    });
                }
            }
        },

        //trade search
        search: {
            url: '/api/user/trade/list',

            form: $('#trade_search_form'),

            init: function() { //init search form
                 // init order status combobox
                this.form.find('input[name="status"]:first').combobox({
                    url: '/api/enum?c=trade&i=status',
                    valueField: 'id',
                    textField: 'text',

                    multiple: true,

                    loadFilter: function(resp){
                        return resp.data;
                    }
                });
            },

            go: function() { // do search
                //check search form
                if(!this.form.form('validate'))
                    return;
                
                // status list
                statuslst = [];

                // status input
                statuss = this.form.find('input[name="status"]');
                for (i=0; i<statuss.length; i++){
                    statuslst.push($(statuss[i]).val());
                }

                //get parameters
                params = {
                    status: statuslst.join(','),
                    sdate: this.form.find('input[name="sdate"]:first').val(),
                    edate: this.form.find('input[name="edate"]:first').val(),
                    words: this.form.find('input[name="words"]:first').val()
                };

                //reload by retrieve conditions
                usertrade.list.load(params);
            },

            reset: function() { // reset
                //clear form
                this.form.form('clear');

                //reload datagrid
                usertrade.list.load({});
            }
        },

        //trade list
        list: {
            url: '/api/user/trade/list',
            datagrid: $('#datagrid_trade'),

            init: function() {
                this.datagrid.datagrid({
                    url: this.url,
                    method: 'get',
                    
                    idField: 'id',
            
                    striped: true,
                    fitColumns: true,
                    pagination: true,
                    rownumbers: false,
                    singleSelect: true,

                    pageSize: 20,
                    pageList: [10, 20, 50, 100],
                    
                    toolbar: '#trade_toolbar',
                    frozenColumns: [[
                        {field:'id', title:'ID', sortable:true},
                        {field:'user', title:'用户'},
                        {field:'stock', title:'股票', hidden:true},
                        {field:'_stock', title:'股票'},
                        {field:'status', title:'状态', hidden:true},
                        {field:'_status', title:'状态'},
                        {field:'account', title:'账户', sortable:true},
                        {field:'tcode', title:'代码', hidden:true},
                        {field:'optype', title:'报价', hidden:true},
                        {field:'_optype', title:'报价'},
                        {field:'lever', title:'杠杆', hidden:true},
                        {field:'_lever', title:'杠杆', sortable:true},
                        {field:'oprice', title:'订单价', sortable:true},
                        {field:'ocount', title:'订单量', sortable:true}

                    ]],
                    columns: [[
                        {field:'hprice', title:'持仓价', sortable:true, formatter: cube.format.none},
                        {field:'hcount', title:'持仓量', sortable:true, formatter: cube.format.none},
                        {field:'fcount', title:'可卖量', sortable:true, formatter: cube.format.none},
                        {field:'bprice', title:'买入价', sortable:true, formatter: cube.format.none},
                        {field:'bcount', title:'买入量', sortable:true, formatter: cube.format.none},
                        {field:'sprice', title:'卖出价', sortable:true, formatter: cube.format.none},
                        {field:'scount', title:'卖出量', sortable:true, formatter: cube.format.none},
                        {field:'margin', title:'初始保证金', sortable:true},
                        {field:'amargin', title:'补充保证金', sortable:true},
                        {field:'ofee', title:'建仓费', sortable:true},
                        {field:'dday', title:'天数', sortable:true, formatter: cube.format.none},
                        {field:'dfee', title:'延期费', sortable:true, formatter: cube.format.none},
                        {field:'tprofit', title:'盈利', sortable:true, formatter: cube.format.none},
                        {field:'sprofit', title:'分成', sortable:true, formatter: cube.format.none},
                        {field:'_coupon', title:'优惠券', sortable:false, formatter: cube.format.none},
                        {field:'ctime', title:'创建日', sortable:true, formatter: cube.format.datetime},
                        {field:'ftime', title:'结束日', sortable:true, formatter: cube.format.datetime}
                    ]],

                    loadFilter: function (resp) {
                        if(!resp.status){
                            $.messager.show({title: '错误', msg: resp.msg});
                            return {total:0, rows:[]}
                        }
                        return resp.data;
                    },

                    onLoadSuccess: function(resp) {
                        //disable edit
                        usertrade.edit.disable();
                        //hide detail
                        usertrade.detail.clear();
                        //clear selections
                        $(this).datagrid('clearSelections');
                    },

                    onLoadError: function() {
                        $.messager.show({title: '错误', msg: '请求用户交易数据失败'});
                    },
                    
                    onSelect: function(index, row) {
                        //enable edit
                        usertrade.edit.enable();
                        // show detail
                        usertrade.detail.show();
                    }
                });
            },

            load: function(params) {
                this.datagrid.datagrid('load', params);
            },

            reload: function() {
                this.datagrid.datagrid('reload');
            },

            insertRow: function(row) {
                index = 0;
                this.datagrid.datagrid('insertRow', {
                  index: index,
                  row: row
                });

                this.datagrid.datagrid('selectRow', index);
            },

            updateRow: function(row) {
                index = this.datagrid.datagrid('getRowIndex', row.id);
                this.datagrid.datagrid('updateRow', {
                    index: index,
                    row: row
                });
                this.datagrid.datagrid('selectRow', index);
            },

            getSelected: function() {
                row = this.datagrid.datagrid('getSelected');
                return row;
            },

            deleteSelected: function() {
                row = this.datagrid.datagrid('getSelected');
                if(!row)
                    return;

                rindex = this.datagrid.datagrid('getRowIndex', row);

                this.datagrid.datagrid('deleteRow', rindex);
            },

            updateSelected: function(rdata) {
                row = this.datagrid.datagrid('getSelected');
                if(!row)
                    return;

                rindex = this.datagrid.datagrid('getRowIndex', row);
                this.datagrid.datagrid('updateRow', {
                    index: rindex,
                    row: rdata
                });
            }
        },

        //trade detail
        detail: {
            // tab component
            tabs: {
                tabs: $('#tabs_trade_detail'),

                inited: false,

                init: function() {
                    if (this.inited)
                        return;

                    this.tabs.tabs({
                        border: false,

                        onSelect: function(title, idx){
                            var rdata = usertrade.list.getSelected();
                            if(!rdata)
                                return;

                            usertrade.detail.tabs.select(idx, rdata.id);
                        }
                    });

                    this.inited = true;
                },

                show: function() {
                    var rdata = usertrade.list.getSelected();
                    if(!rdata)
                        return;

                    $('#tabs_trade_detail').show();
                    $('#empty_trade_detail').hide();

                    // current tab index
                    idx = 0;
                    tab = this.tabs.tabs('getSelected');
                    if(tab) {
                        idx = this.tabs.tabs('getTabIndex', tab);
                    }

                    // change tab
                    this.select(idx, rdata.id);
                },

                clear: function() {
                    $('#tabs_trade_detail').hide();
                    $('#empty_trade_detail').show();
                },

                select: function(idx, tid) {
                    switch (idx) {
                        case 0:
                            usertrade.detail.operation.show(tid);
                            break;
                        case 1:
                            usertrade.detail.trade.show(tid);
                            break;
                        case 2:
                            usertrade.detail.fees.show(tid);
                            break;
                        case 3:
                            usertrade.detail.margins.show(tid);
                            break;
                        case 4:
                            usertrade.detail.orders.show(tid);
                            break;
                        case 5:
                            usertrade.detail.status.show(tid);
                            break;
                        default:
                            break;
                    }
                }
            },

            // trade operation
            operation: {
                show: function(tid) {
                    var url = '/api/user/trade/get?id='+tid+"&_t=d";
                    $.get(url, function(resp, status){
                        if(status === 'success'){
                            if (resp.status){
                                //permit operation
                                status = resp.data.status;
                                if (['tobuy'].includes(status)){
                                    $('#btn_trade_buy').linkbutton('enable');
                                    $('#btn_trade_drop').linkbutton('enable');
                                } else {
                                    $('#btn_trade_buy').linkbutton('disable');
                                    $('#btn_trade_drop').linkbutton('disable');
                                }

                                if (['tosell'].includes(status)){
                                    $('#btn_trade_sell').linkbutton('enable');
                                } else {
                                    $('#btn_trade_sell').linkbutton('disable');
                                }

                                if (['toclose'].includes(status)){
                                    $('#btn_trade_close').linkbutton('enable');
                                } else {
                                    $('#btn_trade_close').linkbutton('disable');
                                }

                                if (['cancelbuy', 'cancelsell', 'cancelclose'].includes(status)){
                                    $('#btn_trade_cancel').linkbutton('enable');
                                } else {
                                    $('#btn_trade_cancel').linkbutton('disable');
                                }

                                //show stock quote
                                secmap = {'600':'1','601':'1','603':'1', '000':'2','002':'2','300':'2'};
                                code = resp.data.rows.stock + secmap[resp.data.rows.stock.substr(0,3)];
                                $('#iframe_trade_quote').attr('src', 'https://emwap.eastmoney.com/quota/stock/index/'+code);
                                //$('#iframe_trade_quote').attr('src', 'http://m.10jqka.com.cn/stockpage/hs_'+resp.data.rows.stock+'/');
                            } else {
                                $.messager.show({title: '错误', msg: resp.msg});
                            }
                        } else {
                            $.messager.show({title: '错误', msg: '请求服务器错误'});
                        }
                    },'json');
                },

                do: function(action) {
                    var row = usertrade.list.getSelected();
                    if(!row)
                        return;

                    var url = '/api/user/trade/process';
                    $.post(url, {id: row.id, act: action}, function(resp, status){
                        if(status === 'success'){
                            if (resp.status){
                                usertrade.list.updateRow(resp.data);
                                $.messager.show({title: '成功', msg: resp.msg});
                            } else {
                                $.messager.show({title: '错误', msg: resp.msg});
                            }
                        } else {
                            $.messager.show({title: '错误', msg: '请求服务器错误'});
                        }
                    },'json');
                }
            },

            // trade detail
            trade: {
                url: '/api/user/trade/get',
                propertygrid: $('#propertygrid_trade_detail'),

                inited: false,

                show: function(tradeid) {
                    if(!this.inited)
                        this.init(tradeid);
                    else
                        this.load(tradeid);
                },

                load: function(tradeid) {
                    this.propertygrid.propertygrid('load', {id: tradeid, _t: 'p'});
                },

                init: function(tradeid) {
                    if (this.inited)
                        return;

                    //init property grid
                    this.initPropertyGrid(tradeid);

                    this.inited = true;
                },

                initPropertyGrid: function(tradeid) {
                    // init trade detail property grid
                    this.propertygrid.propertygrid({
                        url: this.url,
                        method: 'get',
                        queryParams: {id: tradeid, _t: 'p'},
                        
                        showGroup: true,
                        showHeader: true,

                        columns: [[
                            {field:'name', title:'名称', width:'40%'},
                            {field:'value', title:'取值', width:'60%'}
                        ]],

                        loadFilter: function (resp) {
                            if (!resp.status){
                                $.messager.show({ title: '错误',  msg: resp.msg });
                                return;
                            }
                            return resp.data;
                        },

                        onLoadSuccess: function(resp) {
                        },

                        onLoadError: function() {
                            $.messager.show({title: '错误', msg: '请求订单详情数据失败'});
                        }
                    });
                }
            },

            //trade fees
            fees: {
                url: '/api/user/trade/fees',
                datagrid: $('#datagrid_trade_fees'),

                inited: false,

                init: function(tradeid) {
                    this.datagrid.datagrid({
                        url: this.url,
                        method: 'get',
                        queryParams: {id: tradeid},
                        
                        idField: 'id',
                
                        striped: true,
                        fitColumns: true,
                        pagination: false,
                        rownumbers: false,
                        singleSelect: true,

                        columns: [[
                            {field:'item', title:'类目', width:'15%'},
                            {field:'money', title:'金额', width:'40%'},
                            {field:'ctime', title:'时间', formatter: cube.format.datetime}
                        ]],

                        loadFilter: function (resp) {
                            if (!resp.status){
                                $.messager.show({ title: '错误',  msg: resp.msg });
                                return {total:0, rows:[]};
                            }
                            return resp.data;
                        },

                        onLoadSuccess: function(resp) {

                        },

                        onLoadError: function() {
                            $.messager.show({title: '错误', msg: '请求交易费用详情失败'});
                        }
                    });

                    this.inited=true;
                },

                clear: function() {
                    if (this.inited){
                        len = this.datagrid.datagrid('getRows').length;
                        for (i=0; i<len; i++){
                            this.datagrid.datagrid('deleteRow', 0);
                        }
                    }
                },
                
                load: function(tradeid) {
                    this.datagrid.datagrid('load', {id: tradeid});
                },

                show: function(tradeid) {
                    if(!this.inited)
                        this.init(tradeid);
                    else
                        this.load(tradeid);
                }
            },

            // trade margins
            margins: {
                url: '/api/user/trade/margins',
                datagrid: $('#datagrid_trade_margins'),
                
                inited: false,

                init: function(tradeid) {
                   this.datagrid.datagrid({
                        url: this.url,
                        method: 'get',
                        queryParams: {id: tradeid},
                        
                        idField: 'id',
                
                        striped: true,
                        fitColumns: true,
                        pagination: false,
                        rownumbers: true,
                        singleSelect: true,

                        columns: [[
                            {field:'item', title:'类目', width:'20%'},
                            {field:'prepay', title:'预付', width:'20%'},
                            {field:'money', title:'实收', width:'20%'},
                            {field:'ctime', title:'时间', formatter: cube.format.datetime}
                        ]],

                        loadFilter: function (resp) {
                            if (!resp.status){
                                $.messager.show({ title: '错误',  msg: resp.msg });
                                return {total:0, rows:[]};
                            }
                            return resp.data;
                        },

                        onLoadSuccess: function(resp) {

                        },

                        onLoadError: function() {
                            $.messager.show({title: '错误', msg: '请求交易保证金详情失败'});
                        }
                    });

                   this.inited = true;
                },

                clear: function() {
                    if (this.inited){
                        len = this.datagrid.datagrid('getRows').length;
                        for (i=0; i<len; i++){
                            this.datagrid.datagrid('deleteRow', 0);
                        }
                    }
                },

                load: function(tradeid) {
                    this.datagrid.datagrid('load', {id: tradeid});
                },

                show: function(tradeid) {
                    if(!this.inited)
                        this.init(tradeid);
                    else
                        this.load(tradeid);
                }
            },

            // trade orders
            orders: {
                url: '/api/user/trade/orders',
                propertygrid: $('#propertygrid_trade_orders'),
                
                inited: false,
                
                 init: function(tradeid) {
                    if (this.inited)
                        return;

                    this.propertygrid.propertygrid({
                        url: this.url,
                        method: 'get',
                        queryParams: {id: tradeid},
                        
                        showGroup: true,
                        showHeader: true,

                        columns: [[
                            {field:'name', title:'名称', width:'50%'},
                            {field:'value', title:'取值', width:'50%'}
                        ]],

                        loadFilter: function (resp) {
                            if (!resp.status){
                                $.messager.show({ title: '错误',  msg: resp.msg });
                                return {total:0, rows:[]};
                            }

                            return resp.data;
                        },

                        onLoadSuccess: function(resp) {

                        },

                        onLoadError: function() {
                            $.messager.show({title: '错误', msg: '请求交易委托数据失败'});
                        }
                    });

                    this.inited=true;
                },

                clear: function() {
                    if (this.inited){
                        len = this.propertygrid.propertygrid('getRows').length;
                        for (i=0; i<len; i++){
                            this.propertygrid.propertygrid('deleteRow', 0);
                        }
                    }
                },

                load: function(tradeid) {
                    this.propertygrid.propertygrid('load', {id: tradeid});
                },

                show: function(tradeid) {
                    if(!this.inited)
                        this.init(tradeid);
                    else
                        this.load(tradeid);
                }
            },

            // trade status changes
            status: {
                url: '/api/user/trade/status',
                propertygrid: $('#propertygrid_trade_status'),

                inited: false,

                init: function(params) {
                    if (this.inited)
                        return;

                    this.propertygrid.propertygrid({
                        url: this.url,
                        method: 'get',
                        queryParams: params,

                        showGroup:true,

                        columns: [[
                            {field:'name', title:'名称', width:'20%'},
                            {field:'value', title:'取值'}
                        ]],

                        loadFilter: function (resp) {
                            return resp.data;
                        },

                        onLoadSuccess: function(resp) {
                        },

                        onLoadError: function() {
                            $.messager.show({title: '错误', msg: '请求状态变更信息失败'});
                        }
                    });

                    this.inited=true;
                },

                load: function(params) {
                    this.propertygrid.propertygrid('load', params);
                },

                show: function(tradeid) {
                    params = {id:tradeid};
                    if(!this.inited)
                        this.init(params);
                    else
                        this.load(params);
                }
            },

            //init detail
            init: function() {
                this.tabs.init();
            },

            //show detail
            show: function() {
                this.tabs.show();
            },

            //clear detail
            clear:function() {
                this.tabs.clear();
            }
        },

        //init user trade
        init: function() {
            // init search
            this.search.init();
            // init list
            this.list.init();
            // init detail
            this.detail.init();
        }
    };

    //init page
    $(function(){
        //init user trade page
        usertrade.init();
    });

</script>
