
<div class="easyui-layout" data-options="fit:true, split:true, border: true">
    <div data-options="region:'west', split:true" style="width: 75%;">
        <table id="trade_datagrid" style="height: 100%;"></table>
    </div>
    <div data-options="region:'center', split:true" style="width: 25%">
        <div class="easyui-tabs" id="trade_detail_tabs" fit="true" border="true" plain="true">
            <div title="订单详情">
                <div class="easyui-panel" style="height:100%;">
                    <table id="trade_detail_propertygrid"></table>
                </div>
            </div>
            <div title="交易杠杆">
                <div class="easyui-panel" style="height:100%;">
                    <table id="trade_lever_propertygrid"></table>
                </div>
            </div>
            <div title="订单费用">
                <div class="easyui-panel" style="height:100%;">
                    <table id="trade_fees_datagrid"></table>
                </div>
            </div>
            <div title="保证金">
                <div class="easyui-panel" style="height:100%;">
                    <table id="trade_margins_datagrid"></table>
                </div>
            </div>
            <div title="交易委托">
                <div class="easyui-panel" style="height:100%;">
                    <table id="trade_orders_propertygrid"></table>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="trade_toolbar">
    <span>
        <a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="usertrade.add.open()">新建</a>
    </span>
    <span>
        <a href="javascript:void(0)" id="trade_edit_menubutton" class="easyui-menubutton" data-options="menu:'#trade_edit_menu', disabled:true,iconCls:'icon-edit'">编辑</a>
        <div id="trade_edit_menu" style="width:150px;">
            <div iconCls="icon-edit" onclick="usertrade.edit.modify.open()">修改</div>
            <div iconCls="icon-edit" onclick="usertrade.edit.modify.open()">买入</div>
            <div iconCls="icon-edit" onclick="usertrade.edit.modify.open()">卖出</div>
            <div iconCls="icon-edit" onclick="usertrade.edit.modify.open()">平仓</div>
        </div>
    </span>
    <span style="float: right; margin-right: 18px;">
        <form class="easyui-form" id="trade_search_form">
            <input name="status" data-options="prompt:'交易状态', editable:false, required:false" style="width: 16%">
            <span>日期</span>
            <input name="sdate" class="easyui-datebox" validType="date" style="width: 18%">
            <span>-</span>
            <input name="edate" class="easyui-datebox" validType="date" style="width: 18%">

            <input name="words" class="easyui-textbox" style="width: 20%">

            <a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick="usertrade.search.do()">查询</a>
            <a href="#" class="easyui-linkbutton" iconCls="icon-reload" onclick="usertrade.search.reset()">重置</a>
        </form>
    </span>
</div>

<div class="easyui-dialog" id="trade_add_dialog" style="width:400px" data-options="closed:true,modal:true,border:'thin',buttons:'#trade_add_dialog_buttons'">
    <form class="easyui-form" id="trade_add_form" method="post" style="margin:0;padding:10px 20px">
        <div style="margin-bottom:10px">
            <input id="trade_add_user" name="user" label="用户" prompt="输入用户" style="width:100%" required>
        </div>
        <div style="margin-bottom:10px">
           	<input id="trade_add_stock" name="stock" label="股票" prompt="股票代码" style="width:100%" required>
        </div>
        <div style="margin-bottom:10px">
           	<input id="trade_add_lever" name="lever" label="杠杆" prompt="选择杠杆" style="width:100%" required>
        </div>
        <div style="margin-bottom:10px">
            <input id="trade_add_coupon" name="coupon" label="优惠券" prompt="选择优惠券" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input id="trade_add_ptype" name="ptype" label="报价方式" prompt="选择报价方式" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="ocount" data-options="label:'委托数量', prompt:'100的整数倍', required:true, validType:['stock', 'min[100]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" id="trade_add_oprice" name="oprice" data-options="label:'委托价格', prompt:'>0.0', required:true, validType:['number', 'min[0]']" style="width:100%">
        </div>
    </form>
</div>

<div id="trade_add_dialog_buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" onclick="usertrade.add.save()" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="usertrade.add.close()" style="width:90px">取消</a>
</div>


<script type="text/javascript">
    // user trade list/add/update/delete
    var usertrade = {
        // trade add
        add: {
            url: '/api/user/trade/add',

            form: $('#trade_add_form'),
            dialog: $('#trade_add_dialog'),

            inited: false,

            init: function() {
                //init user textbox
                $('#trade_add_user').combobox({
                    url:'/api/user/user/query', 
                    mode: 'remote',

                    valueField:'id',
                    textField:'user',
                    
                    limitToList: true,
                    
                    loadFilter: function(resp) {
                        return resp.data;
                    },
                    
                    onChange: function(newv, oldv) {
                        if($(this).textbox('isValid')){
                            $('#trade_add_coupon').combobox({queryParams: {user:$(this).val(), status:'unused'}}).combobox('reload', '/api/user/coupon/list');
                        }
                    }
                });

                //init stock combobox
                $('#trade_add_stock').combobox({
                    url:'/api/stock/stock/query',
                    mode: 'remote',

                    valueField:'id',
                    textField:'name',

                    limitToList: true,

                    loadFilter: function(resp) {
                        return resp.data;
                    }
                });

                //init lever combobox
                $('#trade_add_lever').combobox({
                    url:'/api/trade/lever/list',
                    editable:false,
                    valueField:'id',
                    textField:'lever',
                    queryParams: {
                        disable: 'false'
                    },
                    loadFilter: function(resp) {
                        return resp.data.rows;
                    }
                });

                //init coupon combobox
                $('#trade_add_coupon').combobox({
                    editable:false,
                    valueField: 'id',
                    textField: 'money',
                    loadFilter: function(resp) {
                        return resp.data.rows;
                    }
                });

                //init ptype combobox
                $('#trade_add_ptype').combobox({
                    editable:false,
                    valueField: 'id',
                    textField: 'text',
                    data: [{id:'sj', text:'市价'},{id:'xj', text:'限价'}],
                    onChange: function(newv, oldv){
                        if (newv == 'sj'){
                            $('#trade_add_oprice').textbox('clear');
                            $('#trade_add_oprice').textbox('disable');
                        } else {
                            $('#trade_add_oprice').textbox('clear');
                            $('#trade_add_oprice').textbox('enable');
                        }
                    }
                });

                //set inited flag
                this.inited = true;
            },

            open: function() { //open dialog
                //reset form
                this.form.form('clear');

                //init add
                if (!this.inited)
                    this.init();
                else
                    this.reload();

                //open dialog
                this.dialog.dialog('open').dialog('center').dialog('setTitle','添加订单');
            },

            close: function() { //close dialog
                //close dialog
                this.dialog.dialog('close');
            },

            save: function() { // save add record
                 //submit form
                this.form.form('submit',{
                    url: this.url,
   
                    onSubmit: function(){
                        return usertrade.add.form.form('validate');
                    },
                    success: function(data){
                        var resp = eval('('+data+')');
                        if (resp.status){
                            usertrade.add.dialog.dialog('close');
                            usertrade.datagrid.datagrid('reload');
                        } else {
                            $.messager.show({ title: '错误',  msg: resp.msg });
                        }
                    }
                });
            },
        },

        //trade search
        search: {
            url: '/api/user/trade/list',

            form: $('#trade_search_form'),

            init: function() { //init search form
                 // init order status combobox
                this.form.find('input[name="status"]:first').combobox({
                    url: '/api/enum?c=trade&i=status',
                    valueField: 'id',
                    textField: 'text',

                    multiple: true,

                    loadFilter: function(resp){
                        return resp.data;
                    }
                });
            },

            do: function() { // do search
                //check search form
                if(!this.form.form('validate'))
                    return;
                
                // status list
                statuslst = []

                // status input
                statuss = this.form.find('input[name="status"]');
                for (i=0; i<statuss.length; i++){
                    statuslst.push($(statuss[i]).val());
                }

                //get parameters
                params = {
                    status: statuslst.join(','),
                    sdate: this.form.find('input[name="sdate"]:first').val(),
                    edate: this.form.find('input[name="edate"]:first').val(),
                    words: this.form.find('input[name="words"]:first').val()
                };

                //reload by retrieve conditions
                usertrade.list.load(params);
            },

            reset: function() { // reset
                //clear form
                this.form.form('clear');

                //reload datagrid
                usertrade.list.load({});
            },
        },

        //trade list
        list: {
            url: '/api/user/trade/list',
            datagrid: $('#trade_datagrid'),

            init: function() {
                this.datagrid.datagrid({
                    url: this.url,
                    method: 'get',
                    
                    idField: 'id',
            
                    striped: true,
                    fitColumns: true,
                    pagination: true,
                    rownumbers: false,
                    singleSelect: true,

                    pageNumber: 1,
                    pageSize: 20,
                    pageList: [5, 10, 20, 30, 40, 50, 100],
                    
                    toolbar: '#trade_toolbar',
                    frozenColumns: [[
                        {field:'id', title:'ID', sortable:true},
                        {field:'user', title:'用户'},
                        {field:'stock', title:'股票'},
                        {field:'account', title:'账户', sortable:true},
                        {field:'ptype', title:'报价'},
                        {field:'status', title:'状态'},
                        {field:'ctime', title:'创建日', sortable:true, formatter: cube.format.datetime},
                        {field:'ftime', title:'结束日', sortable:true, formatter: cube.format.datetime},
                    ]],
                    columns: [[
                        {field:'lever', title:'杠杆', sortable:true},
                        {field:'oprice', title:'订单价', sortable:true},
                        {field:'ocount', title:'订单量', sortable:true},
                        {field:'hprice', title:'持仓价', sortable:true, formatter: cube.format.none},
                        {field:'hcount', title:'持仓量', sortable:true, formatter: cube.format.none},
                        {field:'fcount', title:'可卖量', sortable:true, formatter: cube.format.none},
                        {field:'bprice', title:'买入价', sortable:true, formatter: cube.format.none},
                        {field:'bcount', title:'买入量', sortable:true, formatter: cube.format.none},
                        {field:'sprice', title:'卖出价', sortable:true, formatter: cube.format.none},
                        {field:'scount', title:'卖出量', sortable:true, formatter: cube.format.none},
                        {field:'margin', title:'保证金', sortable:true},
                        {field:'ofee', title:'建仓费', sortable:true},
                        {field:'ddays', title:'天数', sortable:true, formatter: cube.format.none},
                        {field:'dfee', title:'延期费', sortable:true, formatter: cube.format.none},
                        {field:'tprofit', title:'盈利', sortable:true, formatter: cube.format.none},
                        {field:'sprofit', title:'分成', sortable:true, formatter: cube.format.none},
                    ]],

                    loadFilter: function (resp) {
                        return resp.data;
                    },

                    onLoadSuccess: function(resp) {
                        // clear current selected detail
                        usertrade.detail.clear();

                        //clear selections
                        $(this).datagrid('clearSelections');
                    },

                    onLoadError: function() {
                        $.messager.show({title: '错误', msg: '请求用户交易数据失败'});
                    },
                    
                    onSelect(index, row) {
                        // show detail
                        usertrade.detail.show();
                    }
                });
            },

            load: function(params) {
                console.log(params);
                this.datagrid.datagrid('load', params);
            },

            reload: function() {
                this.datagrid.datagrid('reload');
            },

            getSelected: function() {
                row = this.datagrid.datagrid('getSelected');
                return row;
            },

            deleteSelected: function() {
                row = this.datagrid.datagrid('getSelected');
                if(!row)
                    return;

                rindex = this.datagrid.datagrid('getRowIndex', row);

                this.datagrid.datagrid('deleteRow', rindex);
            },

            updateSelected: function(rdata) {
                row = this.datagrid.datagrid('getSelected');
                if(!row)
                    return;

                rindex = this.datagrid.datagrid('getRowIndex', row);
                this.datagrid.datagrid('updateRow', {
                    index: rindex,
                    row: rdata
                });
            }
        },

        //trade detail
        detail: {
            // tab component
            tabs: {
                tabs: $('#trade_detail_tabs'),

                inited: false,

                init: function() {
                    if (this.inited)
                        return;

                    this.tabs.tabs({
                        border: false,

                        onSelect: function(title, index){
                            row = usertrade.list.getSelected();
                            if(!row)
                                return;

                            tradeid = row.id;
                            switch (index) {
                                case 0:
                                    usertrade.detail.trade.show(tradeid);
                                    break;
                                case 1:
                                    usertrade.detail.lever.show(tradeid);
                                    break;
                                case 2:
                                    usertrade.detail.fees.show(tradeid);
                                    break;
                                case 3:
                                    usertrade.detail.margins.show(tradeid);
                                    break;
                                case 4:
                                    usertrade.detail.orders.show(tradeid);
                                    break;
                                default:
                                    // statements_def
                                    break;
                            }
                        }
                    });

                    this.inited = true;
                },

                clear: function() {
                    tab = this.tabs.tabs('getSelected');
                    if(tab) {
                        idx = this.tabs.tabs('getTabIndex', tab);
                        switch (idx) {
                            case 0:
                                usertrade.detail.trade.clear();
                                break;
                            case 1:
                                usertrade.detail.lever.clear();
                                break;
                            case 2:
                                usertrade.detail.fees.clear();
                                break;
                            case 3:
                                usertrade.detail.margins.clear();
                                break;
                            case 4:
                                usertrade.detail.orders.clear();
                                break;
                            default:
                                break;
                        }
                    }
                },

                show: function() {
                    row = usertrade.list.getSelected();
                    if(!row)
                        return;

                    // current trade id
                    tradeid = row.id;
                    // current tab index
                    idx = 0;
                    tab = this.tabs.tabs('getSelected');
                    if(tab) {
                        idx = this.tabs.tabs('getTabIndex', tab);
                    }
                    
                    switch (idx) {
                        case 0:
                            usertrade.detail.trade.show(tradeid);
                            break;
                        case 1:
                            usertrade.detail.lever.show(tradeid);
                            break;
                        case 2:
                            usertrade.detail.fees.show(tradeid);
                            break;
                        case 3:
                            usertrade.detail.margins.show(tradeid);
                            break;
                        case 4:
                            usertrade.detail.orders.show(tradeid);
                            break;
                        default:
                            break;
                    }

                }
            },

            // trade detail
            trade: {
                url: '/api/user/trade/get',
                propertygrid: $('#trade_detail_propertygrid'),

                inited: false,

                init: function(params) {
                    if (this.inited)
                        return;

                    this.propertygrid.propertygrid({
                        url: this.url,
                        method: 'get',
                        queryParams: params,
                        
                        showGroup: true,
                        showHeader: true,

                        columns: [[
                            {field:'name', title:'名称', width:'50%'},
                            {field:'value', title:'取值', width:'50%'}
                        ]],

                        loadFilter: function (resp) {
                            return resp.data;
                        },

                        onLoadSuccess: function(resp) {
                        },

                        onLoadError: function() {
                            $.messager.show({title: '错误', msg: '请求订单详情数据失败'});
                        }
                    });

                    this.inited=true;
                },

                clear: function() {
                    if (this.inited){
                        len = this.propertygrid.propertygrid('getRows').length;
                        for (i=0; i<len; i++){
                            this.propertygrid.propertygrid('deleteRow', 0);
                        }
                    }
                },
                
                load: function(params) {
                    this.propertygrid.propertygrid('load', params);
                },

                show: function(tradeid) {
                    params = {id:tradeid, _t:'p'};
                    if(!this.inited)
                        this.init(params);
                    else
                        this.load(params);
                }
            },


            //trade lever
            lever: {
                url: '/api/user/trade/lever',
                propertygrid: $('#trade_lever_propertygrid'),

                inited: false,

                init: function(params) {
                    if (this.inited)
                        return;

                    this.propertygrid.propertygrid({
                        url: this.url,
                        method: 'get',
                        queryParams: params,
                        
                        showGroup: true,
                        showHeader: true,

                        columns: [[
                            {field:'name', title:'名称', width:'50%'},
                            {field:'value', title:'取值', width:'50%'}
                        ]],

                        loadFilter: function (resp) {
                            return resp.data;
                        },

                        onLoadSuccess: function(resp) {
                        },

                        onLoadError: function() {
                            $.messager.show({title: '错误', msg: '请求交易杠杆数据失败'});
                        }
                    });

                    this.inited=true;
                },

                clear: function() {
                    if (this.inited){
                        len = this.propertygrid.propertygrid('getRows').length;
                        for (i=0; i<len; i++){
                            this.propertygrid.propertygrid('deleteRow', 0);
                        }
                    }
                },
                
                load: function(params) {
                    this.propertygrid.propertygrid('load', params);
                },

                show: function(tradeid) {
                    params = {id:tradeid};
                    if(!this.inited)
                        this.init(params);
                    else
                        this.load(params);
                }
            },

            //trade fees
            fees: {
                url: '/api/user/trade/fees',
                datagrid: $('#trade_fees_datagrid'),

                inited: false,

                init: function(params) {
                    this.datagrid.datagrid({
                        url: this.url,
                        method: 'get',
                        queryParams: params,
                        
                        idField: 'id',
                
                        striped: true,
                        fitColumns: true,
                        pagination: false,
                        rownumbers: false,
                        singleSelect: true,

                        columns: [[
                            {field:'item', title:'类目', width:'16%'},
                            {field:'nmoney', title:'应收', width:'22%'},
                            {field:'amoney', title:'实收', width:'22%'},
                            {field:'ctime', title:'时间', formatter: cube.format.datetime}
                        ]],

                        loadFilter: function (resp) {
                            return resp.data;
                        },

                        onLoadSuccess: function(resp) {
                        },

                        onLoadError: function() {
                            $.messager.show({title: '错误', msg: '请求交易费用详情失败'});
                        }
                    });

                    this.inited=true;
                },

                clear: function() {
                    if (this.inited){
                        len = this.datagrid.datagrid('getRows').length;
                        for (i=0; i<len; i++){
                            this.datagrid.datagrid('deleteRow', 0);
                        }
                    }
                },
                
                load: function(params) {
                    this.datagrid.datagrid('load', params);
                },

                show: function(tradeid) {
                    params = {id:tradeid};
                    if(!this.inited)
                        this.init(params);
                    else
                        this.load(params);
                }
            },

            // trade margins
            margins: {
                url: '/api/user/trade/margins',
                datagrid: $('#trade_margins_datagrid'),
                
                inited: false,

                init: function(params) {
                   this.datagrid.datagrid({
                        url: this.url,
                        method: 'get',
                        queryParams: params,
                        
                        idField: 'id',
                
                        striped: true,
                        fitColumns: true,
                        pagination: false,
                        rownumbers: true,
                        singleSelect: true,

                        columns: [[
                            {field:'item', title:'类目', width:'25%'},
                            {field:'money', title:'金额', width:'30%'},
                            {field:'ctime', title:'时间', formatter: cube.format.datetime}
                        ]],

                        loadFilter: function (resp) {
                            return resp.data;
                        },

                        onLoadSuccess: function(resp) {
                        },

                        onLoadError: function() {
                            $.messager.show({title: '错误', msg: '请求交易保证金详情失败'});
                        }
                    });

                   this.inited = true;
                },

                clear: function() {
                    if (this.inited){
                        len = this.datagrid.datagrid('getRows').length;
                        for (i=0; i<len; i++){
                            this.datagrid.datagrid('deleteRow', 0);
                        }
                    }
                },

                load: function(params) {
                    this.datagrid.datagrid('load', params);
                },

                show: function(tradeid) {
                    params = {id:tradeid};
                    if(!this.inited)
                        this.init(params);
                    else
                        this.load(params);
                }
            },

            // trade orders
            orders: {
                url: '/api/user/trade/orders',
                propertygrid: $('#trade_orders_propertygrid'),
                
                inited: false,
                
                 init: function(params) {
                    if (this.inited)
                        return;

                    this.propertygrid.propertygrid({
                        url: this.url,
                        method: 'get',
                        queryParams: params,
                        
                        showGroup: true,
                        showHeader: true,

                        columns: [[
                            {field:'name', title:'名称', width:'50%'},
                            {field:'value', title:'取值', width:'50%'}
                        ]],

                        loadFilter: function (resp) {
                            return resp.data;
                        },

                        onLoadSuccess: function(resp) {
                        },

                        onLoadError: function() {
                            $.messager.show({title: '错误', msg: '请求交易委托数据失败'});
                        }
                    });

                    this.inited=true;
                },

                clear: function() {
                    if (this.inited){
                        len = this.propertygrid.propertygrid('getRows').length;
                        for (i=0; i<len; i++){
                            this.propertygrid.propertygrid('deleteRow', 0);
                        }
                    }
                },

                load: function(params) {
                    this.propertygrid.propertygrid('load', params);
                },

                show: function(tradeid) {
                    params = {id:tradeid};
                    if(!this.inited)
                        this.init(params);
                    else
                        this.load(params);
                }
            },

            //init detail
            init: function() {
                this.tabs.init();
            },

            //show detail
            show: function() {
                this.tabs.show();
            },

            //clear detail
            clear:function() {
                this.tabs.clear();
            },
        },

        //init user trade
        init: function() {
            // init search
            this.search.init();
            // init list
            this.list.init();
            // init detail
            this.detail.init();
        }
    };

    //init page
    $(function(){
        //init user trade page
        usertrade.init();
    });

</script>
