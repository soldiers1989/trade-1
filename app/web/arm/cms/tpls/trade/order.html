<div class="easyui-layout" data-options="fit:true, split:true, border: true">
    <div data-options="region:'west', split:true" style="width: 75%;">
        <table id="order_datagrid" style="height: 100%;"></table>
    </div>
    <div data-options="region:'center', split:true" style="width: 25%">
        <div class="easyui-panel" title="委托状态" style="height:50%;">
            <table id="order_status_datagrid"></table>
        </div>
        <div class="easyui-panel" title="交易状态" style="height:50%;">
            <table id="trade_status_datagrid"></table>
        </div>
    </div>
</div>

<div id="order_toolbar">
    <span>
        <a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="order.add.open()">新建</a>
        <a href="#" class="easyui-linkbutton" iconCls="icon-edit" plain="true" onclick="order.update.open()">编辑</a>
        <a href="#" class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick="order.delete.do()">删除</a>
    </span>
    <span style="float: right; margin-right: 18px;">
        <form class="easyui-form" id="order_search_form">
            <input name="otype" data-options="prompt:'委托类型', editable:false, required:false">
            <input name="ptype" data-options="prompt:'报价类型', editable:false, required:false">
            <input name="status" data-options="prompt:'交易状态', editable:false, required:false">
            <span>日期</span>
            <input name="sdate" class="easyui-datebox" validType="date">
            <span>-</span>
            <input name="edate" class="easyui-datebox" validType="date">
            <input name="words" class="easyui-textbox">

            <a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick="order.search.do()">查询</a>
            <a href="#" class="easyui-linkbutton" iconCls="icon-reload" onclick="order.search.reset()">重置</a>
        </form>
    </span>
</div>

<div class="easyui-dialog" id="order_add_dialog" style="width:400px" data-options="closed:true,modal:true,border:'thin',buttons:'#order_add_dialog_buttons'">
    <form class="easyui-form" id="order_add_form" method="post" style="margin:0;padding:10px 20px">
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="name" data-options="label:'账户名称', prompt:'输入证券账户名', required:true, validType:['text', 'length[1,16]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="account" data-options="label:'交易账户', prompt:'输入交易账户', required:true, validType:['text', 'length[1,16]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="lmoney" data-options="label:'账户余额', prompt:'输入账户余额（元）', required:true, validType:['number', 'min[0]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="cfmin" data-options="label:'最低佣金', prompt:'输入交易佣金最低金额（元）', required:true, validType:['number', 'min[0]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="cfrate" data-options="label:'佣金费率', prompt:'输入佣金费率（0.0~1.0）', required:true, validType:['number', 'range[0,1]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="tfrate" data-options="label:'印花税率', prompt:'输入印花税率（0.0~1.0）', required:true, validType:['number', 'range[0,1]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <select class="easyui-combobox" name="disable" data-options="label:'账户状态', prompt:'选择账户状态', editable:false, required:true" style="width: 100%">
                <option value="false">启用</option>
                <option value="true">禁用</option>
            </select>
        </div>
    </form>
</div>

<div id="order_add_dialog_buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" onclick="order.add.save()" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="order.add.cancel()" style="width:90px">取消</a>
</div>

<div class="easyui-dialog" id="order_update_dialog" style="width:400px" data-options="closed:true,modal:true,border:'thin',buttons:'#order_update_dialog_buttons'">
    <form class="easyui-form" id="order_update_form" method="post" style="margin:0;padding:10px 20px">
        <div style="margin-bottom:10px">
            <input class="easyui-textbox"  name="id" type="text" label="ID" style="width:100%" disabled>
        </div>
         <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="name" data-options="label:'账户名称', prompt:'输入证券账户名', required:true, validType:['text', 'length[1,16]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="account" data-options="label:'交易账户', prompt:'输入交易账户', required:true, validType:['text', 'length[1,16]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="lmoney" data-options="label:'账户余额', prompt:'输入账户余额（元）', required:true, validType:['number', 'min[0]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="cfmin" data-options="label:'最低佣金', prompt:'输入交易佣金最低金额（元）', required:true, validType:['number', 'min[0]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="cfrate" data-options="label:'佣金费率', prompt:'输入佣金费率（0.0~1.0）', required:true, validType:['number', 'range[0,1]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="tfrate" data-options="label:'印花税率', prompt:'输入印花税率（0.0~1.0）', required:true, validType:['number', 'range[0,1]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <select class="easyui-combobox" name="disable" data-options="label:'是否禁用', prompt:'选择账户状态', editable:false, required:true" style="width: 100%">
                <option value="false">否</option>
                <option value="true">是</option>
            </select>
        </div>
    </form>
</div>

<div id="order_update_dialog_buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" onclick="order.update.save()" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="order.update.cancel()" style="width:90px">取消</a>
</div>

<script type="text/javascript">
    // order list/add/update/delete
    var order = {
        // order list
        list: {
            url: '/api/trade/order/list',
            datagrid: $('#order_datagrid'),

            init: function() {
            	//init tree grid
                this.datagrid.datagrid({
                    url: this.url,
                    method: 'post',

                    idField: 'id',

    				striped: true,
    				fitColumns: true,
                    pagination: true,
                    rownumbers: false,
                    singleSelect: true,

                    pageNumber: 1,
                    pageSize: 20,
                    pageList: [20, 30, 40, 50, 100],

    				toolbar: '#order_toolbar',

                    frozenColumns: [[
                        {field:'id', title:'ID', sortable:true},
                        {field:'stock', title:'股票名称', sortable:false},
                        {field:'account', title:'交易账户', sortable:true},
                        {field:'ostatus', title:'委托状态', sortable:true},
                        {field:'status', title:'交易状态', sortable:true},
                     
                    ]],

                    columns: [[
                        {field:'otype', title:'委托类型', sortable:true},
                        {field:'ptype', title:'报价类型', sortable:true},
                        {field:'ocount', title:'委托数量', sortable:true},
                        {field:'oprice', title:'委托价格', sortable:true},
                        {field:'ocode', title:'委托编号', sortable:true},
                        {field:'otime', title:'委托时间', sortable:true, formatter: cube.format.datetime},
                        {field:'dcount', title:'成交数量', sortable:true},
                        {field:'dprice', title:'成交价格', sortable:true},
                        {field:'dtime', title:'成交时间', sortable:true, formatter: cube.format.datetime}
                    ]],

                    loadFilter: function (resp) {
                        return resp.data;
                    },

                    onLoadError: function() {
                        $.messager.show({title: '错误', msg: '请求交易账户记录数据失败'});
                    }
                });
            },

            load: function(params) {
                this.datagrid.datagrid('load', params);
            },

            reload: function() {
                this.datagrid.datagrid('reload');
            },

            getSelected: function() {
                return this.datagrid.datagrid('getSelected');
            }
        },

        //search action
        search: {
            form: $('#order_search_form'),

            init: function() { //init search form
                // init order type combobox
                this.form.find('input[name="otype"]:first').combobox({
                    data: [{v:'', t:'全部'}, {v:'buy', t:'买入'}, {v:'sell', t:'卖出'}],
                    valueField: 'v',
                    textField: 't'
                });

                // init price type combobox
                this.form.find('input[name="ptype"]:first').combobox({
                    data: [{v:'', t:'全部'}, {v:'xj', t:'限价'}, {v:'sj', t:'市价'}],
                    valueField: 'v',
                    textField: 't'
                });

                // init price type combobox
                this.form.find('input[name="ptype"]:first').combobox({
                    data: [{v:'', t:'全部'}, {v:'xj', t:'限价'}, {v:'sj', t:'市价'}],
                    valueField: 'v',
                    textField: 't'
                });
            },

            do: function() { // do search
                //check search form
                if(!this.form.form('validate'))
                    return;

                //get parameters
                params = {
                    disable: this.form.find('input[name="disable"]:first').val(),
                    words: this.form.find('input[name="words"]:first').val()
                };

                //reload by retrieve conditions
                order.list.load(params);
            },

            reset: function() { // reset
                //clear form
                this.form.form('clear');

                //reload datagrid
                order.list.load({});
            },
        },

        //add action
        add: {
            url: '/api/trade/order/add',
            dialog: $('#order_add_dialog'),
            form: $('#order_add_form'),

            init: function() { // init add
            },

            open: function() { // open add
                //reset form
                this.form.form('clear');

                //open dialog
                this.dialog.dialog('open').dialog('center').dialog('setTitle','添加交易账户');
            },

            save: function() { // save add
                this.form.form('submit',{
                    url: this.url,
                    queryParams: {},

                    onSubmit: function(){
                        return order.add.form.form('validate');
                    },

                    success: function(data){
                        var resp = eval('('+data+')');
                        if (resp.status){
                            order.add.dialog.dialog('close');
                            order.list.reload();
                        } else {
                            $.messager.show({ title: '错误',  msg: resp.msg });
                        }
                    }
                });
            },

            cancel: function() { //cancel add
                //close dialog
                this.dialog.dialog('close');
            },
        },

        //update action
        update: {
            url: '/api/trade/order/update',
            dialog: $('#order_update_dialog'),
            form: $('#order_update_form'),

            // open update dialoag
            open: function() {
                //get selected row data
                row = order.list.getSelected();
                if (row){
                    row.disable = String(row.disable)
                    // clear form
                    this.form.form('clear');

                    //load form data
                    this.form.form('load', row);

                    //open dialog
                    this.dialog.dialog('open').dialog('center').dialog('setTitle','修改交易账户');
                }
            },

            // save update results
            save: function() {
                var params={};
                // get selected row data
                var row = order.list.getSelected();
                if (!row)
                    return;
                params.id = row.id;


                //submit form
                this.form.form('submit',{
                    url: this.url,
                    queryParams: params,
                    onSubmit: function(){
                        return order.update.form.form('validate');
                    },
                    success: function(data){
                        var resp = eval('('+data+')');
                        if (resp.status){
                            order.update.dialog.dialog('close');
                            order.list.reload();
                        } else {
                            $.messager.show({ title: '错误',  msg: resp.msg });
                        }
                    }
                });
            },

            // cancel update operation
            cancel: function() {
                //close dialog
                this.dialog.dialog('close');
            },
        },

        // delete row
        delete: {
            url: '/api/trade/order/delete',

            do: function() { // delete
                // delete action url
                url = this.url;

                //get selected row data
                var row = order.list.getSelected();
                if (!row)
                    return;

                $.messager.confirm({
                    title: '确认',
                    msg: '确认删除交易账户'+row.name+'?',
                    url: order.delete.url,
                    fn: function(r){
                        if (r){
                            $.post(url, {id: row.id}, function(resp, status){
                                if(status == 'success'){
                                    if (resp.status){
                                        order.list.reload();
                                    } else {
                                        $.messager.show({title: '错误', msg: resp.msg});
                                    }
                                } else {
                                    $.messager.show({title: '错误', msg: '请求服务器错误'});
                                }
                            },'json');
                        }
                    }
                });
            },
        },

        // order detail


        //init order
        init: function() {
            // init search
            this.search.init();
            // init list
            this.list.init();
            // init add form
            this.add.init();
        }
    };

    //init page
    $(function(){
        //init order
        order.init();
    });

</script>
