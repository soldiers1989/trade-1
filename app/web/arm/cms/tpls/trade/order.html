
<div class="easyui-layout" data-options="fit:true, split:true, border: true">
    <div data-options="region:'west', split:true" style="width: 75%;">
        <table id="order_datagrid" style="height: 100%;"></table>
    </div>
    <div data-options="region:'center', split:true, title:'订单详情'" style="width: 25%">
        <table id="admin_role_datagrid" style="height: 100%;"></table>
    </div>
</div>

<div id="order_toolbar">
    <span>
        <a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="order.add()">新建</a>
        <a href="#" class="easyui-linkbutton" iconCls="icon-edit" plain="true" onclick="order.update()">编辑</a>
    </span>
    <span style="float: right; margin-right: 18px;">
        <form class="easyui-form" id="order_search_form">
            <span>日期</span>
            <input id="sdate" class="easyui-datebox" validType="date">
            <span>-</span>
            <input id="edate" class="easyui-datebox" validType="date">

            <input id="words" class="easyui-textbox">

            <a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick="order.list()">查询</a>
            <a href="#" class="easyui-linkbutton" iconCls="icon-search" onclick="order.reset()">重置</a>
        </form>
    </span>
</div>

<div class="easyui-dialog" id="lever_dialog" style="width:400px" data-options="closed:true,modal:true,border:'thin',buttons:'#lever_dialog_buttons'">
    <form class="easyui-form" id="lever_form" method="post" style="margin:0;padding:10px 20px">
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="lever" data-options="label:'杠杆', prompt:'1~10', required:true, validType:['digits', 'range[1, 10]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="wline" data-options="label:'预警线', prompt:'0.0~1.0', required:true, validType:['number', 'range[0,1]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="sline" data-options="label:'止损线', prompt:'0.0~1.0', required:true, validType:['number', 'range[0,1]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="ofmin" data-options="label:'保底费用', prompt:'>=0.0', required:true, validType:['number', 'min[0]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="ofrate" data-options="label:'建仓费率', prompt:'0.0~1.0', required:true, validType:['number', 'range[0,1]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="dfrate" data-options="label:'延期费率', prompt:'0.0~1.0', required:true, validType:['number', 'range[0,1]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="psrate" data-options="label:'盈利分成', prompt:'0.0~1.0', required:true, validType:['number', 'range[0,1]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" id="mmin" name="mmin" data-options="label:'本金下限', prompt:'>=0.0', required:true, validType:['number', 'min[0]']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <input class="easyui-textbox" name="mmax" data-options="label:'本金上限', prompt:'大于等于本金下限', required:true, validType:['number', 'largeequal[\'#mmin\']']" style="width:100%">
        </div>
        <div style="margin-bottom:10px">
            <select class="easyui-combobox" name="disable" data-options="label:'禁用', prompt:'是否禁用', editable:false, required:true" style="width: 100%">
                <option value="false">否</option>
                <option value="true">是</option>
            </select>
        </div>
    </form>
</div>

<div id="lever_dialog_buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" onclick="order.save()" style="width:90px">保存</a>
    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="order.cancel()" style="width:90px">取消</a>
</div>


<script type="text/javascript">
    // order list/add/update/delete
    var order = {
        datagrid: $('#order_datagrid'),
        dialogs: {
        	add: $('#order_add_dialog'),
        	mod: $('#order_mod_dialog'),
        },

        forms: {
        	add: $('#order_add_form'),
        	mod: $('#order_mod_form'),
        	search: $('#order_search_form'),
        },

        action: '',
        urls: {
            list: '/api/trade/order/list',
            add: '/api/trade/order/add',
            update: '/api/trade/order/update',
        },

        init: function() { //init
        	//init tree grid
            this.datagrid.datagrid({
                url: this.urls.list,
                method: 'post',
                
                idField: 'id',
 		
				striped: true,
				fitColumns: true,
                pagination: false,
                rownumbers: false,
                singleSelect: true,
                
				toolbar: '#order_toolbar',
				frozenColumns: [[
				    {field:'id', title:'ID'},
                    {field:'user', title:'用户'},
                    {field:'stock', title:'股票'},
                    {field:'lever', title:'杠杆'},
					{field:'statusd', title:'状态'},
					{field:'ctime', title:'创建日', formatter: cube.format.date},
                    {field:'ftime', title:'结束日', formatter: cube.format.date},
				]],
                columns: [[
                    {field:'hprice', title:'持仓价', formatter: cube.format.none},
                    {field:'hcount', title:'持仓量', formatter: cube.format.none},
                    {field:'fcount', title:'可卖量', formatter: cube.format.none},
                    {field:'oprice', title:'订单价'},
                    {field:'ocount', title:'订单量'},
                    {field:'bprice', title:'买入价', formatter: cube.format.none},
                    {field:'bcount', title:'买入量', formatter: cube.format.none},
                    {field:'sprice', title:'卖出价', formatter: cube.format.none},
                    {field:'scount', title:'卖出量', formatter: cube.format.none},
                    {field:'margin', title:'保证金'},
                    {field:'ofee', title:'建仓费'},
                    {field:'ddays', title:'天数', formatter: cube.format.none},
                    {field:'dfee', title:'延期费', formatter: cube.format.none},
                    {field:'tprofit', title:'盈利', formatter: cube.format.none},
                    {field:'sprofit', title:'分成', formatter: cube.format.none},
                ]],

                loadFilter: function (resp) {
                    return resp.data;
                },

                onLoadSuccess: function(resp) {
                },

                onLoadError: function() {
                    $.messager.show({title: '错误', msg: '请求管理员数据失败'});
                }
            });

            //enable drag/drop
            //this.datagrid.datagrid('enableDnd');
        },
        
   
        list: function() { // list
            //check search form
            if(!this.forms.search.form('validate'))
                return;

            //get parameters
            params = {
                sdate: this.forms.search.children('#sdate').val(),
                edate: this.forms.search.children('#edate').val(),
                words: this.forms.search.children('#words').val()
            };

            //reload by retrieve conditions
            this.datagrid.datagrid('load', params);
        },

        reset: function() { // reset
            //clear form
            this.forms.search.form('clear');

            //reload datagrid
            this.datagrid.datagrid('load', {});
        },

        add: function() { // add
            //reset action
            this.action = 'add';

            //reset form
            this.form.form('clear');

            //open dialog
            this.dialog.dialog('open').dialog('center').dialog('setTitle','添加杠杆');
        },

        update: function() { // udpate
            //reset action
            this.action = 'update';
            
            //get selected row data
            this.row = this.datagrid.datagrid('getSelected');
            if (this.row){
            	// format boolean value
            	this.row.disable = String(this.row.disable);

                // clear form
                this.form.form('clear');

                //load form data
                this.form.form('load', this.row);

                //option dialog
                this.dialog.dialog('open').dialog('center').dialog('setTitle','修改杠杆');
            }
        },

        save: function() { // save
            //get selected row data
            var row = this.datagrid.datagrid('getSelected');
            if (!row)
                return;

            var url, params={};
            // get action url
            if(this.action == 'add') {
                url = this.urls.add;
            } else if (this.action == 'update'){
                params.id = row.id;
                url = this.urls.update;
            } else {
                return;
            }

            //submit form
            this.form.form('submit',{
                url: url,
                queryParams: params,   
                onSubmit: function(){
                    return order.form.form('validate');
                },
                success: function(data){
                    var resp = eval('('+data+')');
                    if (resp.status){
                        order.dialog.dialog('close');
                        order.datagrid.datagrid('reload');
                    } else {
                        $.messager.show({ title: '错误',  msg: resp.message });
                    }
                }
            });
        },

        cancel: function() { //cancel
            //clear action
            this.action = '';

            //close dialog
            this.dialog.dialog('close');
        },
    };

    //init page
    $(function(){
        //init order
        order.init();
    });

</script>
